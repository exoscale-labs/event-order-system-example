# Backend

The backend is a simple NodeJS application with Express, consisting of two API Calls and Socket.IO.

It uses node-postgres to save orders to a PostgreSQL database. When a order is saved, it is also emited via
Socket.IO, so that viewers have a live-ticker of incoming orders.

Via an API Call, all orders of the database can be listed.

The application is horizontally scaleable as it's stateless. However the Socket.IO part isn't completly, as clients can only see incoming orders on the replica of the app where there are connected to (can be easily fixed by using Socket.IO adapters). The GET orders API call always show all orders, as they are retrieved from the DB.

The CORS setting currently allows any host.

## Developing
Make sure NodeJS is installed.

`npm install` to install all packages
`npm start` to start the app

Before starting, make sure the database credentials are in your environment:
```
PGHOST=....aivencloud.com
PGPORT=21699
PGUSER=avnadmin
PGPASSWORD=
PGDATABASE=exoscale-order
PGSSLMODE=require
```

The providers certificate is in the `CA` folder.

### Files
`main.js` has the routes
`order.js` functions for accessing the database

## Database scheme

See/Import `sql/order.sql`

## API

### Order drink

Order a drink. The client must provide a generated UUID.
The client can use the same UUID for further requests to replace the existing drink or nickname.

**URL** : `/drink/:drinkid`
**Method** : `GET`

#### Parameters

`:drinkid/` Drinkid (freely defined by frontend)
`?nickname` Nickname, must be shorter than 32
`?userid` UUID generated by the client, identifies the order

#### Success Response

**Code** : `200 OK`

### Get Orders

List all orders

**URL** : `/orders`
**Method** : `GET`

#### Success Response

**Code** : `200 OK`

**Content examples**

```json
[{
	"userid": "0f1a6f1d-5215-404c-8b76-629e567d48d2",
	"nickname": "Max",
	"drinkid": 3,
    "time": "2022-03-09T13:59:28.103Z"
}, {
	"userid": "836dba39-03a4-4426-adeb-ba2462072897",
	"nickname": "Bella",
	"drinkid": 2,
    "time": "2022-03-09T13:59:35.103Z"
}]
```

## Socket.IO

### Order notification
Emited by the server, when a order took place. Includes the drinkid and the nickname of the person who ordered it.

**Key** : `ordernotification`

**Content examples**
```json
{ "drinkid": 3, "nickname": "max" }
```